<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<meta content="chkpoint_two_ode.cpp, checkpointing, an, ode, solver:, example, and, test" name="keywords" />
<meta content="purpose" name="keywords" />
<meta content="problem" name="keywords" />
<meta content="ode, solver" name="keywords" />
<meta content="ode" name="keywords" />
<meta content="solution" name="keywords" />
<meta content="source" name="keywords" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>chkpoint_two_ode.cpp &mdash; cppad  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="bool_valued" href="bool_valued.html" />
    <link rel="prev" title="chkpoint_two_dynamic.cpp" href="chkpoint_two_dynamic.cpp.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="xrst_root_doc.html" class="icon icon-home"> cppad
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="xrst_table_of_contents.html">Table of Contents</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="CppAD.html">CppAD</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Install.html">Install</a></li>
<li class="toctree-l2"><a class="reference internal" href="Theory.html">Theory</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="AD.html">AD</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="ad_ctor.html">ad_ctor</a></li>
<li class="toctree-l3"><a class="reference internal" href="ad_assign.html">ad_assign</a></li>
<li class="toctree-l3"><a class="reference internal" href="Convert.html">Convert</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="ADValued.html">ADValued</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="Arithmetic.html">Arithmetic</a></li>
<li class="toctree-l4"><a class="reference internal" href="unary_standard_math.html">unary_standard_math</a></li>
<li class="toctree-l4"><a class="reference internal" href="binary_math.html">binary_math</a></li>
<li class="toctree-l4"><a class="reference internal" href="CondExp.html">CondExp</a></li>
<li class="toctree-l4"><a class="reference internal" href="Discrete.html">Discrete</a></li>
<li class="toctree-l4"><a class="reference internal" href="numeric_limits.html">numeric_limits</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="atomic.html">atomic</a><ul class="current">
<li class="toctree-l5"><a class="reference internal" href="atomic_four.html">atomic_four</a></li>
<li class="toctree-l5"><a class="reference internal" href="atomic_three.html">atomic_three</a></li>
<li class="toctree-l5 current"><a class="reference internal" href="chkpoint_two.html">chkpoint_two</a><ul class="current">
<li class="toctree-l6"><a class="reference internal" href="chkpoint_two_ctor.html">chkpoint_two_ctor</a></li>
<li class="toctree-l6"><a class="reference internal" href="chkpoint_two_chk_fun.html">chkpoint_two_chk_fun</a></li>
<li class="toctree-l6"><a class="reference internal" href="chkpoint_two_dynamic.html">chkpoint_two_dynamic</a></li>
<li class="toctree-l6"><a class="reference internal" href="chkpoint_two_get_started.cpp.html">chkpoint_two_get_started.cpp</a></li>
<li class="toctree-l6"><a class="reference internal" href="chkpoint_two_compare.cpp.html">chkpoint_two_compare.cpp</a></li>
<li class="toctree-l6"><a class="reference internal" href="chkpoint_two_base2ad.cpp.html">chkpoint_two_base2ad.cpp</a></li>
<li class="toctree-l6"><a class="reference internal" href="chkpoint_two_dynamic.cpp.html">chkpoint_two_dynamic.cpp</a></li>
<li class="toctree-l6 current"><a class="current reference internal" href="#">chkpoint_two_ode.cpp</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="bool_valued.html">bool_valued</a></li>
<li class="toctree-l3"><a class="reference internal" href="VecAD.html">VecAD</a></li>
<li class="toctree-l3"><a class="reference internal" href="base_require.html">base_require</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ADFun.html">ADFun</a></li>
<li class="toctree-l2"><a class="reference internal" href="preprocessor.html">preprocessor</a></li>
<li class="toctree-l2"><a class="reference internal" href="multi_thread.html">multi_thread</a></li>
<li class="toctree-l2"><a class="reference internal" href="utility.html">utility</a></li>
<li class="toctree-l2"><a class="reference internal" href="ipopt_solve.html">ipopt_solve</a></li>
<li class="toctree-l2"><a class="reference internal" href="Example.html">Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="speed.html">speed</a></li>
<li class="toctree-l2"><a class="reference internal" href="Appendix.html">Appendix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="xrst_index.html">Index</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="xrst_root_doc.html">cppad</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="xrst_root_doc.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="CppAD.html">CppAD</a> &raquo;</li>
          <li><a href="AD.html">AD</a> &raquo;</li>
          <li><a href="ADValued.html">ADValued</a> &raquo;</li>
          <li><a href="atomic.html">atomic</a> &raquo;</li>
          <li><a href="chkpoint_two.html">chkpoint_two</a> &raquo;</li>
      <li>chkpoint_two_ode.cpp</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/chkpoint_two_ode.cpp.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <p class="hidden"><span class="math notranslate nohighlight">\(\newcommand{\W}[1]{ \; #1 \; }\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\R}[1]{ {\rm #1} }\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\B}[1]{ {\bf #1} }\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\D}[2]{ \frac{\partial #1}{\partial #2} }\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\DD}[3]{ \frac{\partial^2 #1}{\partial #2 \partial #3} }\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\Dpow}[2]{ \frac{\partial^{#1}}{\partial  {#2}^{#1}} }\)</span>
<span class="math notranslate nohighlight">\(\newcommand{\dpow}[2]{ \frac{ {\rm d}^{#1}}{{\rm d}\, {#2}^{#1}} }\)</span></p>
<section id="chkpoint-two-ode-cpp">
<span id="chkpoint-two-ode-cpp-name"></span><h1>chkpoint_two_ode.cpp<a class="headerlink" href="#chkpoint-two-ode-cpp" title="Permalink to this headline"></a></h1>
<section id="checkpointing-an-ode-solver-example-and-test">
<span id="chkpoint-two-ode-cpp-title"></span><span id="index-0"></span><h2>Checkpointing an ODE Solver: Example and Test<a class="headerlink" href="#checkpointing-an-ode-solver-example-and-test" title="Permalink to this headline"></a></h2>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#purpose" id="id1">Purpose</a></p></li>
<li><p><a class="reference internal" href="#problem" id="id2">Problem</a></p></li>
<li><p><a class="reference internal" href="#ode-solver" id="id3">ODE Solver</a></p></li>
<li><p><a class="reference internal" href="#ode" id="id4">ODE</a></p></li>
<li><p><a class="reference internal" href="#solution" id="id5">Solution</a></p></li>
<li><p><a class="reference internal" href="#source" id="id6">Source</a></p></li>
</ul>
</div>
<section id="purpose">
<span id="chkpoint-two-ode-cpp-purpose"></span><span id="index-1"></span><h3><a class="toc-backref" href="#id1">Purpose</a><a class="headerlink" href="#purpose" title="Permalink to this headline"></a></h3>
<p>In this example we <a class="reference internal" href="chkpoint_two.html#chkpoint-two-name"><span class="std std-ref">checkpoint</span></a> one step of an ODE solver.</p>
</section>
<section id="problem">
<span id="chkpoint-two-ode-cpp-problem"></span><span id="index-2"></span><h3><a class="toc-backref" href="#id2">Problem</a><a class="headerlink" href="#problem" title="Permalink to this headline"></a></h3>
<p>We consider the initial value problem with parameter <span class="math notranslate nohighlight">\(x\)</span> defined by,
<span class="math notranslate nohighlight">\(z(0, x) = z_0 (x)\)</span>,</p>
<div class="math notranslate nohighlight">
\[\partial_t z(t, x ) = h [ x , z(t, x) ]\]</div>
<p>Note that if <span class="math notranslate nohighlight">\(t\)</span> needs to be in the equation, one can define
the first component of <span class="math notranslate nohighlight">\(z(t, x)\)</span> to be equal to <span class="math notranslate nohighlight">\(t\)</span>.</p>
</section>
<section id="ode-solver">
<span id="chkpoint-two-ode-cpp-ode-solver"></span><span id="index-3"></span><h3><a class="toc-backref" href="#id3">ODE Solver</a><a class="headerlink" href="#ode-solver" title="Permalink to this headline"></a></h3>
<p>For this example, we consider the Fourth order Runge-Kutta ODE solver.
Given an approximation solution at time <span class="math notranslate nohighlight">\(t_k\)</span> denoted by
<span class="math notranslate nohighlight">\(\tilde{z}_k (x)\)</span>, and <span class="math notranslate nohighlight">\(\Delta t = t_{k+1} - t_k\)</span>,
it defines the approximation solution <span class="math notranslate nohighlight">\(\tilde{z}_{k+1} (x)\)</span>
at time <span class="math notranslate nohighlight">\(t_{k+1}\)</span> by</p>
<div class="math notranslate nohighlight">
\begin{eqnarray}
h_1 &amp; =  &amp; h [ x , \tilde{z}_k (x) ]
\\
h_2 &amp; =  &amp; h [ x , \tilde{z}_k (x) + \Delta t \; h_1 / 2 ]
\\
h_3 &amp; =  &amp; h [ x , \tilde{z}_k (x) + \Delta t \; h_2 / 2 ]
\\
h_4 &amp; =  &amp; h [ x , \tilde{z}_k (x) + \Delta t \; h_3 ]
\\
\tilde{z}_{k+1} (x) &amp; = &amp;
   \tilde{z}_k (x) + \Delta t \; ( h_1 +  2 h_2 + 2 h_3 + h_4 ) / 6
\end{eqnarray}</div><p>If <span class="math notranslate nohighlight">\(\tilde{z}_k (x) = z_k (x)\)</span>,
<span class="math notranslate nohighlight">\(\tilde{z}_{k+1} (x) = z_{k+1} (x) + O( \Delta t^5 )\)</span>.
Other ODE solvers can use a similar method to the one used below.</p>
</section>
<section id="ode">
<span id="chkpoint-two-ode-cpp-ode"></span><span id="index-4"></span><h3><a class="toc-backref" href="#id4">ODE</a><a class="headerlink" href="#ode" title="Permalink to this headline"></a></h3>
<p>For this example the ODE is defined by
<span class="math notranslate nohighlight">\(z(0, x) = 0\)</span> and</p>
<div class="math notranslate nohighlight">
\[\begin{split}h[ x, z(t, x) ] =
\left( \begin{array}{c}
      x_0                     \\
      x_1 z_0 (t, x)          \\
      \vdots                  \\
      x_{n-1} z_{n-2} (t, x)
\end{array} \right)
=
\left( \begin{array}{c}
      \partial_t z_0 (t , x)      \\
      \partial_t z_1 (t , x)      \\
      \vdots                      \\
      \partial_t z_{n-1} (t , x)
\end{array} \right)\end{split}\]</div>
</section>
<section id="solution">
<span id="chkpoint-two-ode-cpp-solution"></span><span id="index-5"></span><h3><a class="toc-backref" href="#id5">Solution</a><a class="headerlink" href="#solution" title="Permalink to this headline"></a></h3>
<p>The solution of the ODE for this example,
which is used to check the results,
can be calculated by
starting with the first row and then using the solution
for the first row to solve the second and so on.
Doing this we obtain</p>
<div class="math notranslate nohighlight">
\[\begin{split}z(t, x) =
\left( \begin{array}{c}
   x_0 t                  \\
   x_1 x_0 t^2 / 2        \\
   \vdots                 \\
   x_{n-1} x_{n-2} \ldots x_0 t^n / n !
\end{array} \right)\end{split}\]</div>
</section>
<section id="source">
<span id="chkpoint-two-ode-cpp-source"></span><span id="index-6"></span><h3><a class="toc-backref" href="#id6">Source</a><a class="headerlink" href="#source" title="Permalink to this headline"></a></h3>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cp">#</span><span class="w"> </span><span class="cp">include</span><span class="w"> </span><span class="cpf">&lt;cppad/cppad.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">   </span><span class="k">using</span><span class="w"> </span><span class="n">CppAD</span><span class="o">::</span><span class="n">AD</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">typedef</span><span class="w"> </span><span class="n">AD</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w">                     </span><span class="n">a1double</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">typedef</span><span class="w"> </span><span class="n">AD</span><span class="o">&lt;</span><span class="n">a1double</span><span class="o">&gt;</span><span class="w">                   </span><span class="n">a2double</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="k">typedef</span><span class="w"> </span><span class="n">CPPAD_TESTVECTOR</span><span class="p">(</span><span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="n">a0vector</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">typedef</span><span class="w"> </span><span class="n">CPPAD_TESTVECTOR</span><span class="p">(</span><span class="w"> </span><span class="n">a1double</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="n">a1vector</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">typedef</span><span class="w"> </span><span class="n">CPPAD_TESTVECTOR</span><span class="p">(</span><span class="w"> </span><span class="n">a2double</span><span class="w"> </span><span class="p">)</span><span class="w">   </span><span class="n">a2vector</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// set once by main and kept that way</span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">delta_t_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">quiet_NaN</span><span class="p">();</span><span class="w"></span>
<span class="w">   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n_</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// The function h( x , y)</span>
<span class="w">   </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">FloatVector</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">   </span><span class="n">FloatVector</span><span class="w"> </span><span class="n">h</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">y</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">FloatVector</span><span class="w"> </span><span class="nf">result</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="c1">// The 4-th Order Runge-Kutta Step</span>
<span class="w">   </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">FloatVector</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">   </span><span class="n">FloatVector</span><span class="w"> </span><span class="n">Runge4</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">z0</span><span class="w"></span>
<span class="w">   </span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">z0</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">typedef</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">FloatVector</span><span class="o">::</span><span class="n">value_type</span><span class="w"> </span><span class="n">Float</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="n">Float</span><span class="w">  </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Float</span><span class="p">(</span><span class="n">delta_t_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">m</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">z0</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="n">FloatVector</span><span class="w"> </span><span class="nf">h1</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="w"> </span><span class="n">h2</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="w"> </span><span class="n">h3</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="w"> </span><span class="n">h4</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="w"> </span><span class="n">result</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">h1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">z0</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">h2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">h2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">h2</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">h3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="n">h3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">h3</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">h4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">h3</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">h4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">h</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">h4</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w">  </span><span class="n">Float</span><span class="w"> </span><span class="n">dz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">h1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">h2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0</span><span class="o">*</span><span class="n">h3</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">h4</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">6.0</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dz</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="c1">// pack x and z into an axz vector</span>
<span class="w">   </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">FloatVector</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="n">pack</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w">         </span><span class="n">axz</span><span class="w">      </span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w">   </span><span class="n">x</span><span class="w">        </span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w">   </span><span class="n">z</span><span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">axz</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">axz</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">axz</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="c1">// unpack an axz vector</span>
<span class="w">   </span><span class="k">template</span><span class="w"> </span><span class="o">&lt;</span><span class="k">class</span><span class="w"> </span><span class="nc">FloatVector</span><span class="o">&gt;</span><span class="w"></span>
<span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="n">unpack</span><span class="p">(</span><span class="w"></span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w">         </span><span class="n">axz</span><span class="w">      </span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w">               </span><span class="n">x</span><span class="w">        </span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">FloatVector</span><span class="o">&amp;</span><span class="w">               </span><span class="n">z</span><span class="w">        </span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">axz</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">z</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w">      </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axz</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axz</span><span class="p">[</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">];</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>

<span class="w">   </span><span class="c1">// Algorithm that z(t, x)</span>
<span class="w">   </span><span class="kt">void</span><span class="w"> </span><span class="n">ode_algo</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">a1vector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">axz_in</span><span class="p">,</span><span class="w"> </span><span class="n">a1vector</span><span class="o">&amp;</span><span class="w"> </span><span class="n">axz_out</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">axz_in</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="kt">size_t</span><span class="p">(</span><span class="w"> </span><span class="n">axz_out</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// initial ode information</span>
<span class="w">      </span><span class="n">a1vector</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="n">n_</span><span class="p">),</span><span class="w"> </span><span class="n">z0</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">unpack</span><span class="p">(</span><span class="n">axz_in</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">z0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// advance z(t, x)</span>
<span class="w">      </span><span class="n">a1vector</span><span class="w"> </span><span class="n">z1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Runge4</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">z0</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="c1">// final ode information</span>
<span class="w">      </span><span class="n">pack</span><span class="p">(</span><span class="n">axz_out</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">z1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="c1">//</span>
<span class="w">      </span><span class="k">return</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
<span class="c1">//</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">ode</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">ok</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">using</span><span class="w"> </span><span class="n">CppAD</span><span class="o">::</span><span class="n">NearEqual</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">eps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">epsilon</span><span class="p">();</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// number of terms in the differential equation</span>
<span class="w">   </span><span class="n">n_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">6</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// step size for the differentiail equation</span>
<span class="w">   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">double</span><span class="w"> </span><span class="n">T</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">delta_t_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="kt">double</span><span class="p">(</span><span class="n">n_step</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// set parameter value and initial value of the ode</span>
<span class="w">   </span><span class="n">a1vector</span><span class="w"> </span><span class="nf">ax</span><span class="p">(</span><span class="n">n_</span><span class="p">),</span><span class="w"> </span><span class="n">az0</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">a1double</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">az0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a1double</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// pack ode information input vector</span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// function corresponding to one step of the ode Algorithm</span>
<span class="w">   </span><span class="n">a1vector</span><span class="w"> </span><span class="n">axz_in</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_</span><span class="p">),</span><span class="w"> </span><span class="n">axz_out</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">pack</span><span class="p">(</span><span class="n">axz_in</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">az0</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">CppAD</span><span class="o">::</span><span class="n">Independent</span><span class="p">(</span><span class="n">axz_in</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">ode_algo</span><span class="p">(</span><span class="n">axz_in</span><span class="p">,</span><span class="w"> </span><span class="n">axz_out</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">CppAD</span><span class="o">::</span><span class="n">ADFun</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ode_fun</span><span class="p">(</span><span class="n">axz_in</span><span class="p">,</span><span class="w"> </span><span class="n">axz_out</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// create checkpoint version of the algorithm</span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">internal_bool</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_hes_sparsity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_base2ad</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="kt">bool</span><span class="w"> </span><span class="n">use_in_parallel</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="n">CppAD</span><span class="o">::</span><span class="n">chkpoint_two</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ode_check</span><span class="p">(</span><span class="n">ode_fun</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ode&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">      </span><span class="n">internal_bool</span><span class="p">,</span><span class="w"> </span><span class="n">use_hes_sparsity</span><span class="p">,</span><span class="w"> </span><span class="n">use_base2ad</span><span class="p">,</span><span class="w"> </span><span class="n">use_in_parallel</span><span class="w"></span>
<span class="w">   </span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// set the independent variables for recording</span>
<span class="w">   </span><span class="n">CppAD</span><span class="o">::</span><span class="n">Independent</span><span class="p">(</span><span class="w"> </span><span class="n">ax</span><span class="w"> </span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// repack to get dependence on ax</span>
<span class="w">   </span><span class="n">pack</span><span class="p">(</span><span class="n">axz_in</span><span class="p">,</span><span class="w"> </span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">az0</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// Now run the checkpoint algorithm n_step times</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_step</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">ode_check</span><span class="p">(</span><span class="n">axz_in</span><span class="p">,</span><span class="w"> </span><span class="n">axz_out</span><span class="p">);</span><span class="w"></span>
<span class="w">      </span><span class="n">axz_in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">axz_out</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// Unpack the results (must use ax1 so do not overwrite ax)</span>
<span class="w">   </span><span class="n">a1vector</span><span class="w"> </span><span class="n">ax1</span><span class="p">(</span><span class="n">n_</span><span class="p">),</span><span class="w"> </span><span class="n">az1</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">unpack</span><span class="p">(</span><span class="n">axz_out</span><span class="p">,</span><span class="w"> </span><span class="n">ax1</span><span class="p">,</span><span class="w"> </span><span class="n">az1</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// We could record a complicated funciton of x and z(T, x) in f,</span>
<span class="w">   </span><span class="c1">// but make this example simpler we record x -&gt; z(T, x).</span>
<span class="w">   </span><span class="n">CppAD</span><span class="o">::</span><span class="n">ADFun</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">f</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="w"> </span><span class="n">az1</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// check function values</span>
<span class="w">   </span><span class="n">a0vector</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="n">n_</span><span class="p">),</span><span class="w"> </span><span class="n">z1</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">double</span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">z1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">Forward</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// separate calculation of z(t, x)</span>
<span class="w">   </span><span class="n">a0vector</span><span class="w"> </span><span class="nf">check_z1</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="n">check_z1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">T</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">check_z1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">check_z1</span><span class="p">[</span><span class="n">i</span><span class="mi">-1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="kt">double</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// expected accuracy for each component of of z(t, x)</span>
<span class="w">   </span><span class="n">a0vector</span><span class="w"> </span><span class="nf">acc</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w">  </span><span class="c1">// Runge-Kutta methos is exact for this case</span>
<span class="w">         </span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">10.</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">eps</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">      </span><span class="k">else</span><span class="w"></span>
<span class="w">      </span><span class="p">{</span><span class="w">  </span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="w">         </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w"> </span><span class="n">k</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">               </span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">delta_t_</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="c1">// check z1(T, x)</span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">      </span><span class="n">ok</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="n">NearEqual</span><span class="p">(</span><span class="n">z1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">check_z1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">acc</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="c1">// Now use f to compute a derivative. For this &#39;simple&#39; example it is</span>
<span class="w">   </span><span class="c1">// the derivative of z_{n-1} (T, x) respect to x of the</span>
<span class="w">   </span><span class="n">a0vector</span><span class="w"> </span><span class="nf">w</span><span class="p">(</span><span class="n">n_</span><span class="p">),</span><span class="w"> </span><span class="n">dw</span><span class="p">(</span><span class="n">n_</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"></span>
<span class="w">      </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">n_</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">)</span><span class="w"></span>
<span class="w">         </span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="n">dw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">Reverse</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"></span>
<span class="w">   </span><span class="p">{</span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">z1</span><span class="p">[</span><span class="n">n_</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">];</span><span class="w"></span>
<span class="w">      </span><span class="n">ok</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="n">NearEqual</span><span class="p">(</span><span class="n">dw</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">check</span><span class="p">,</span><span class="w"> </span><span class="mf">100.</span><span class="o">*</span><span class="n">eps</span><span class="p">,</span><span class="w"> </span><span class="mf">100.</span><span class="o">*</span><span class="n">eps</span><span class="p">);</span><span class="w"></span>
<span class="w">   </span><span class="p">}</span><span class="w"></span>
<span class="w">   </span><span class="c1">//</span>
<span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">ok</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="chkpoint_two_dynamic.cpp.html" class="btn btn-neutral float-left" title="chkpoint_two_dynamic.cpp" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="bool_valued.html" class="btn btn-neutral float-right" title="bool_valued" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>